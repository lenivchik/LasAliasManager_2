<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:LasAliasManager.GUI.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
        x:Class="LasAliasManager.GUI.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/favicon.ico"
        Title="Менеджер псевдонимов кривых LAS"
        Width="1400" Height="800"
        MinWidth="900" MinHeight="500"
        WindowStartupLocation="CenterScreen">

    
    <Grid RowDefinitions="Auto,Auto,30,*,30,Auto">
        <!-- 0: Меню -->
        <Menu Grid.Row="0">
            <MenuItem Header="Файл">
                <MenuItem Header="Загрузить базу данных..." Click="LoadDatabase_Click"/>
                <MenuItem Header="Загрузить директорию..." Click="LoadFolder_Click"/>
                <Separator/>
                <MenuItem Header="Сохранить изменения в БД" Command="{Binding SaveChangesCommand}" 
                          IsEnabled="{Binding HasUnsavedChanges}"/>
                <Separator/>
                <MenuItem Header="Экспортировать в txt..." Click="ExportSelectedCurves_Click"/>
                <MenuItem Header="Выход" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="Изменить">
                <MenuItem Header="Обновить страницу" Command="{Binding RefreshViewCommand}"/>
                <MenuItem Header="Очистить все изменения" Command="{Binding ClearAllChangesCommand}"/>
                <Separator/>
                <MenuItem Header ="Применить ко всем" 
        Command="{Binding ApplyToAllCommand}"
        ToolTip.Tip="Применить основное имя выбранной кривой ко всем кривым с таким же полевым именем"/>
                                <Separator/>
                <MenuItem Header="Управление основными именами..." Click="ManageBaseNames_Click"/>
                <Separator/>
                <MenuItem Header="Выбрать все в файле" Command="{Binding SelectAllCurvesCommand}"/>
                <MenuItem Header="Отменить выбор" Command="{Binding DeselectAllCurvesCommand}"/>
            </MenuItem>
            <MenuItem Header="Помощь">
                <MenuItem Header="О программе" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- 1: Панель инструментов -->
        <Border Grid.Row="1" Background="#F0F0F0" Padding="8">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Загрузить базу данных" Click="LoadDatabase_Click" 
                        ToolTip.Tip="Загрузить данные c БД (CSV файл)"/>
                <Button Content="Выбрать директорию" Click="LoadFolder_Click"
                        ToolTip.Tip="Выбрать папку с Las файлами"/>
                <Rectangle Width="1" Fill="Gray" Margin="4,0"/>
                <Button Content="Сохранить изменения в БД" Command="{Binding SaveChangesCommand}"
                        IsEnabled="{Binding HasUnsavedChanges}"
                        ToolTip.Tip="Сохранить изменения в БД"/>
                <Rectangle Width="1" Fill="Gray" Margin="4,0"/>
                <CheckBox Content="Включить вложенные файлы" IsChecked="{Binding IncludeSubfolders}"
                          VerticalAlignment="Center"/>
                <CheckBox Content="Показывать только неопределенные" IsChecked="{Binding ShowOnlyUnknown}"
                          VerticalAlignment="Center" Margin="16,0,0,0"/>
                <Button Content="⟵ Назад" 
        Command="{Binding UndoLastChangeCommand}" 
        IsEnabled="{Binding CanUndo}"
        ToolTip.Tip="{Binding UndoDescription}"/>
            </StackPanel>
        </Border>

        <!-- 2: Панель информации (предупреждение о несохранённых изменениях) -->
        <Border Grid.Row="2" Background="#E8F4FD" Padding="8" 
                IsVisible="{Binding HasUnsavedChanges}">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="!" FontSize="16" VerticalAlignment="Center" FontWeight="Bold" Foreground="Orange"/>
                <TextBlock Text="Найдены несохраненные изменения!!!" 
                           VerticalAlignment="Center" FontWeight="SemiBold"/>
            </StackPanel>
        </Border>

        <!-- 3: Основное содержимое — разделённый вид -->
        <Grid Grid.Row="3" ColumnDefinitions="300,Auto,*" Margin="8">
            
            <!-- Левая панель: Список файлов -->
            <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="1" CornerRadius="4">
                <Grid RowDefinitions="Auto,*">
                    <!-- Заголовок списка файлов -->
                    <Border Grid.Row="0" Background="#E0E0E0" Padding="8">
                        <TextBlock Text="LAS Файлы" FontWeight="Bold"/>
                    </Border>
                    
                    <!-- Список файлов -->
                    <ListBox Grid.Row="1" 
                             x:Name="FileListBox"
                             ItemsSource="{Binding FilteredFiles}"
                             SelectedItem="{Binding SelectedFile}"
                             Background="White">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:LasFileViewModel">
                                <Border Padding="4" Background="{Binding BackgroundColor}">
                                    <StackPanel>
                                        <TextBlock Text="{Binding FileName}" FontWeight="SemiBold"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="{Binding CurveCount, StringFormat='Кривые: {0}'}" 
                                                       FontSize="11" Foreground="Gray"/>
                                            <TextBlock Text="{Binding UnknownCount, StringFormat=' | Неизвестные: {0}'}" 
                                                       FontSize="11" Foreground="Orange"
                                                       IsVisible="{Binding HasUnknown}"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding FileSizeFormatted}" 
                                                   FontSize="10" Foreground="Gray"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Разделитель -->
            <GridSplitter Grid.Column="1" Width="5" Background="Transparent" 
                          ResizeDirection="Columns" ResizeBehavior="PreviousAndNext"/>

            <!-- Правая панель: Кривые выбранного файла -->
            <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="1" CornerRadius="4">
                <Grid RowDefinitions="Auto,Auto,*">
                    <!-- Заголовок панели кривых -->
                    <Border Grid.Row="0" Background="#E0E0E0" Padding="8">
                        <StackPanel>
                            <TextBlock Text="{Binding SelectedFile.FileName, FallbackValue='Выберите файл'}" 
                                       FontWeight="Bold"/>
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0"
                                        IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="{Binding SelectedFile.TopFormatted, StringFormat='Кровля: {0}'}" 
                                           FontSize="11" Margin="0,0,16,0"/>
                                <TextBlock Text="{Binding SelectedFile.BottomFormatted, StringFormat='Подошва: {0}'}" 
                                           FontSize="11" Margin="0,0,16,0"/>
                                <TextBlock Text="{Binding SelectedFile.StepFormatted, StringFormat='Шаг: {0}'}" 
                                           FontSize="11" Margin="0,0,16,0"/>

                            </StackPanel>
                        </StackPanel>
                    </Border>
                    
                    <!-- Фильтр -->
                    <Border Grid.Row="1" Padding="8" Background="#F8F8F8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Фильтр:" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding FilterText}" Width="200" Watermark="Поиск кривых..."/>
                        </StackPanel>
                    </Border>

                    <!-- Таблица кривых -->
                    <DataGrid Grid.Row="2"
                              x:Name="CurvesGrid"
                              ItemsSource="{Binding FilteredCurves}"
                              SelectedItem="{Binding SelectedCurveRow, Mode=TwoWay}"
                              CanUserResizeColumns="True"
                              CanUserReorderColumns="True"
                              CanUserSortColumns="True"
                              GridLinesVisibility="All"
                              IsReadOnly="False"
                              SelectionMode="Extended"
                              Background="White"
                              FocusAdorner="{x:Null}">

                            <DataGrid.Styles>
                                <Style Selector="DataGridColumnHeader">
                                    <Setter Property="FontSize" Value="16"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="Foreground" Value="DarkBlue"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                </Style>
                            </DataGrid.Styles>
                        <DataGrid.Columns>
                            
                            <!-- Флажок выбора -->
                            <DataGridTemplateColumn Header="Экспорт">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="vm:CurveRowViewModel">
                                        <CheckBox IsChecked="{Binding IsSelectedForExport, Mode=TwoWay}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>


                            <!-- Полевое имя кривой -->
                            <DataGridTextColumn Header="Полевое имя" 
                                                Binding="{Binding CurveFieldName}"
                                                Width="150"
                                                IsReadOnly="True"/>
                            
<!-- Основное имя (расширенный ComboBox с фильтрацией) -->
<DataGridTemplateColumn Header="Основное имя" Width="200">
    <DataGridTemplateColumn.CellTemplate>
        <DataTemplate x:DataType="vm:CurveRowViewModel">
            <Grid ColumnDefinitions="*,Auto">
                <!-- Редактируемое текстовое поле для ввода/фильтрации -->
                <TextBox Grid.Column="0"
                         Text="{Binding SearchText, Mode=TwoWay}"
                         Watermark="Начните вводить для фильтрации..."
                         VerticalContentAlignment="Center"
                         GotFocus="PrimaryNameTextBox_GotFocus"
                         LostFocus="PrimaryNameTextBox_LostFocus"/>
                
                <!-- Кнопка раскрытия списка -->
                <Button Grid.Column="1"
                        Content="▼"
                        Width="25"
                        Padding="0"
                        Click="ShowPrimaryNamesDropdown_Click"
                        ToolTip.Tip="Показать все базовые имена"/>
                
                <!-- Всплывающий список с фильтрацией -->
                <Popup Grid.Column="0"
                       Grid.ColumnSpan="2"
                       IsOpen="{Binding IsComboBoxOpen, Mode=TwoWay}"
                       PlacementTarget="{Binding $parent[Grid]}"
                       Width="{Binding $parent[Grid].Bounds.Width}"
                       MaxHeight="300"
                       IsLightDismissEnabled="True">
                    <Border BorderBrush="Gray" 
                            BorderThickness="1" 
                            Background="White"
                            CornerRadius="4"
                            BoxShadow="0 4 8 0 #40000000">
                        <ListBox ItemsSource="{Binding FilteredPrimaryNames}"
                                 SelectionChanged="PrimaryNameListBox_SelectionChanged"
                                 MaxHeight="280"
                                 Background="White">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" Padding="2"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </Popup>
            </Grid>
        </DataTemplate>
    </DataGridTemplateColumn.CellTemplate>
</DataGridTemplateColumn>
                            <!-- Статус с цветовой индикацией -->
                            <DataGridTemplateColumn Header="Статус" Width="150" SortMemberPath="StatusText" >
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="vm:CurveRowViewModel">
                                        <TextBlock Text="{Binding StatusText}"
                                                   Foreground="{Binding StatusColor}"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center"
                                                   FontWeight="SemiBold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

                <!-- Строка 4: Панель информации о кривой -->
        <Border Grid.Row="4" Background="#F5F5DC" Padding="8,4" 
                IsVisible="{Binding SelectedCurveInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="{Binding SelectedCurveInfo}" 
                       FontStyle="Italic"
                       TextWrapping="Wrap"/>
        </Border>



        <!-- Строка 5: Строка состояния -->
        <Border Grid.Row="5" Background="#E0E0E0" Padding="8,4">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" TextWrapping="Wrap" Width="500"/>
                <TextBlock Text="{Binding TotalFiles, StringFormat='Файлов: {0}'}" 
                           Margin="16,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding TotalCurves, StringFormat='Всего кривых: {0}'}" 
                           Margin="16,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding UnknownCurves, StringFormat='Неизвестных: {0}'}" 
                           Margin="16,0" VerticalAlignment="Center" Foreground="Orange"/>
                <TextBlock Text="{Binding SelectedForExportCount, StringFormat='Выбрано: {0}'}" 
                           Margin="16,0" VerticalAlignment="Center" Foreground="Blue"/>
                <ProgressBar IsIndeterminate="True" Width="100" 
                             IsVisible="{Binding IsLoading}" Margin="16,0,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
